<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin | Portfolio</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="style.css" rel="stylesheet">
</head>
<body>
  <nav class="navbar navbar-expand-lg bg-body-tertiary shadow-sm fixed-top">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html" id="brand">Portfolio</a>
      <div class="d-flex align-items-center">
        <a href="index.html" class="nav-link px-2">Home</a>
        <a href="blog.html" class="nav-link px-2">Blog</a>
        <button id="themeToggle" class="btn ms-2"></button>
      </div>
    </div>
  </nav>

  <main class="container my-5 pt-4">
    <div id="adminArea"></div>
  </main>

  <script src="data/data.js"></script>
  <script type="module">
    import { mountPetiteApp } from './js/app-common.js';
    import { initAdminFirebase, adminLogin, adminLogout, onAuthChange, publishPost, fetchPostsForAdmin, deletePostById } from './js/admin-firebase.js';

    const app = await mountPetiteApp();
    const data = window.App || {};
    document.getElementById('brand').textContent = data.name || 'Portfolio';

    // theme button
    const themeBtn = document.getElementById('themeToggle');
    function renderThemeBtn(theme) { themeBtn.className = theme==='dark' ? 'btn btn-outline-light ms-2' : 'btn btn-outline-dark ms-2'; themeBtn.innerHTML = theme==='dark' ? '<i class="bi bi-sun"></i>' : '<i class="bi bi-moon"></i>'; }
    renderThemeBtn(app.theme);
    themeBtn.addEventListener('click', ()=>{app.toggleTheme(); renderThemeBtn(app.theme);});

    // init firebase
    initAdminFirebase();

    // admin UI renderers
    const adminArea = document.getElementById('adminArea');

    function renderLogin() {
      adminArea.innerHTML = `
        <div class="card p-4 mx-auto" style="max-width:480px">
          <h3 class="mb-3">Admin Login</h3>
          <div class="mb-3"><input id="loginEmail" class="form-control" placeholder="Email"></div>
          <div class="mb-3"><input id="loginPassword" type="password" class="form-control" placeholder="Password"></div>
          <div><button id="loginBtn" class="btn btn-primary">Login</button></div>
        </div>`;
      document.getElementById('loginBtn').onclick = async ()=>{
        const e=document.getElementById('loginEmail').value;
        const p=document.getElementById('loginPassword').value;
        try { await adminLogin(e,p); } catch(err){ alert('Login failed: '+err.message); }
      };
    }

    async function renderDashboard(user) {
      const posts = await fetchPostsForAdmin();
      adminArea.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2>Blog Editor</h2>
          <button id="logoutBtn" class="btn btn-danger">Logout</button>
        </div>
        <div class="card p-3 mb-4">
          <input id="postTitle" class="form-control mb-2" placeholder="Title">
          <textarea id="postContent" class="form-control mb-2" rows="6" placeholder="Content"></textarea>
          <div><button id="publishBtn" class="btn btn-success">Publish</button></div>
        </div>
        <h4>Existing Posts</h4>
        <ul id="postsList" class="list-group mt-2"></ul>
      `;
      document.getElementById('logoutBtn').onclick = async ()=>{ await adminLogout(); };
      document.getElementById('publishBtn').onclick = async ()=>{
        const title=document.getElementById('postTitle').value.trim();
        const content=document.getElementById('postContent').value.trim();
        if(!title||!content){ alert('Fill both fields'); return; }
        try {
          await publishPost({ title, content });
          document.getElementById('postTitle').value='';
          document.getElementById('postContent').value='';
          await refreshPostsList();
          alert('Published');
        } catch(e){ alert('Publish failed: '+e.message); }
      };

      async function refreshPostsList(){
        const list = document.getElementById('postsList');
        list.innerHTML = '';
        (await fetchPostsForAdmin()).forEach(p=>{
          const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between align-items-center';
          li.innerHTML = `<div><strong>${p.title}</strong><br><small class="text-muted">${new Date(p.date).toLocaleString()}</small></div>
                          <div><button class="btn btn-sm btn-outline-danger">Delete</button></div>`;
          li.querySelector('button').onclick = async ()=>{
            if(confirm('Delete this post?')) {
              await deletePostById(p.id);
              refreshPostsList();
            }
          };
          list.appendChild(li);
        });
      }
      await refreshPostsList();
    }

    // listen for auth state and render UI
    onAuthChange((user) => {
      if (user) renderDashboard(user);
      else renderLogin();
    });
  </script>
</body>
</html>
